version: 0.2

phases:
    pre_build:
        commands:
            - COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
            - IMAGE_TAG=${COMMIT_HASH:=latest}
            - aws ecr get-login-password --region ap-southeast-2 | docker login --username AWS --password-stdin ${REPOSITORY_URI}
            - ls -al

    build:
        commands:
            - docker build -t ${REPOSITORY_URI}:latest .
            - docker tag ${REPOSITORY_URI}:latest ${REPOSITORY_URI}:$IMAGE_TAG

    post_build:
        commands:
            - docker push ${REPOSITORY_URI}:latest
            - docker push ${REPOSITORY_URI}:$IMAGE_TAG

artifacts:
    files:
        - "bin/Release/net9.0/publish/**/*"
        - "appspec.yml"
        - "deploy_scripts/**/*"
    base-directory: "backend/Music.Backend"
    name: "backend"
